<?php
 /**
 * Add a new node
 *  
 * @package viennaCMS
 * @author viennainfo.nl
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 */

define('IN_VIENNACMS', true);
include('../start.php');
$user = user::getnew();
$user->checkacpauth();

$display_admin_tree = (empty($_GET['display_admin_tree']) ) ?  1 : 0;
$mode = isset($_GET['mode']) ? $_GET['mode'] : 'choose';
$node = new CMS_Node();
$node->node_id = (isset($_GET['node'])) ? $_GET['node'] : $_POST['node'];
$node->read();
$page_title = __("viennaCMS ACP - Edit the node modules");

switch($mode) {
	case 'save':
		if ($_POST['key'] != 'empty') {
			$thing = &$node->revision->modules[$_POST['location']][$_POST['key']];
		} else {
			$thing = &$node->revision->modules[$_POST['location']];
			$thing = &$thing[count($thing)];
		}
		
		if (is_null($thing)) {
			$thing = array();
		}
		
		if (isset($_POST['submit'])) {
			foreach ($_POST as $key => $value) {
				if ($key != 'key' && $key != 'location' && $key != 'node' && $key != 'submit') {
					$thing[$key] = stripslashes($value);
				}
			}
		} else if (isset($_POST['delete'])) {
			unset($node->revision->modules[$_POST['location']][$_POST['key']]);
		}
		
		$node->write();
		header('Location: ' . utils::base() . 'admin_node.php?node=' . $node->node_id);
		exit;
	break;
	case 'args':
		include('./header.php');
		
		if (isset($_GET['location']) && isset($_GET['key'])) {
			$args = $node->revision->modules[$_GET['location']][$_GET['key']];
			$exists = true;
		} else {
			$temp = explode('::', $_POST['extmod']);
			$args = array(
				'extension' => $temp[0],
				'module' => $temp[1]
			);
			$exists = false;
		}
		
		?>
		<form action="?mode=save" method="post">
			<input type="hidden" name="extension" value="<?php echo $args['extension'] ?>" />
			<input type="hidden" name="module" value="<?php echo $args['module'] ?>" />
			<input type="hidden" name="location" value="<?php echo $_GET['location'] ?>" />
			<input type="hidden" name="key" value="<?php echo (isset($_GET['key'])) ? $_GET['key'] : 'empty' ?>" />
			<input type="hidden" name="node" value="<?php echo $node->node_id ?>" />
			<table width="100%">
		<?php
		
		$aargs = utils::run_hook_all('args_' . $args['module']);
		
		foreach ($aargs as $key => $value) {
			$colspan = ($value['newrow']) ? ' colspan="2"' : '';
			?>
			<tr>
				<td<?php echo $colspan ?> style="vertical-align: top;"><strong><?php echo $value['title'] ?>:</strong></td>
				<?php
				if ($value['newrow']) {
					echo '</tr><tr>';
				}
				?>
				<td<?php echo $colspan ?>>
				<?php
				switch ($value['type']) {
					case 'text':
						?>
						<input type="text" name="<?php echo $key ?>" value="<?php echo $args[$key] ?>" /></td>
						<?php
					break;
					case 'textarea':
						?>
						<textarea name="<?php echo $key ?>" rows="5" cols="40"><?php echo stripslashes(preg_replace('#\<br \/\>#', '', $args[$key])); ?></textarea>
						<?php
					break;
					case 'wysiwyg':
						// TODO: add a real wysiwyg
						?>
						<textarea class="wysiwyg" name="<?php echo $key ?>" style="width: 500px; height: 250px;"><?php echo stripslashes(preg_replace("#\<br \/\>#", '', $args[$key])); ?></textarea>
						<?php
					break;
				}
				?>
				</td>
			</tr>
			<?php
		}
		?>
			<tr>
				<td>
					<strong><?php echo __("Title"); ?></strong><br />
					<?php echo __("Enter the title to display"); ?>
				</td>
				
				<td>
					<input type="text" name="content_title" value="<?php echo $args['content_title']; ?>" />
				</td>
			</tr>
			
			<tr>
				<td colspan="2">
					<input type="submit" name="submit" value="<?php echo __('Save') ?>" />
					<?php
					if ($exists) {
						?>
						&nbsp;&nbsp;<input type="submit" name="delete" value="<?php echo __('Delete') ?>" />
						<?php
					}
					?>
				</td>
			</tr>
			</table>
		</form>
		<?php
		include('./footer.php');
	break;
	case 'module':
		include('./header.php');
		if (isset($_POST['submit-left'])) {
			$location = 'left';
		} else if (isset($_POST['submit-middle'])) {
			$location = 'middle';
		} else if (isset($_POST['submit-right'])) {
			$location = 'right';
		}
		?>
		<form method="post" action="?mode=args&amp;location=<?php echo $location ?>">
			<input type="hidden" name="node" value="<?php echo $node->node_id ?>" />
			<h1><?php echo __('Select module type') ?></h1>
			<?php
			$modules = utils::run_hook_all('list_modules');
			
			foreach ($modules as $module => $extension) {
				?>
				<input type="radio" name="extmod" value="<?php echo $extension . '::' . $module; ?>" /> <?php echo $module ?><br />
				<?php
			}
			?>
			<input type="submit" value="<?php echo __('Continue') ?>" />
		</form>
		<?php
		include('./footer.php');
	break;
	default:
	case 'choose':
		include('./header.php');
		?>
		<form action="?mode=module" method="post">
			<div style="width: 33%; float: left;">
				<h2><?php echo __('Left') ?></h2>
				<?php show_modform('left') ?>
			</div>
			<div style="width: 33%; float: left;">
				<h2><?php echo __('Middle') ?></h2>
				<?php show_modform('middle') ?>
			</div>
			<div style="width: 33%; float: left;">
				<h2><?php echo __('Right') ?></h2>
				<?php show_modform('right') ?>
			</div>
			<input type="hidden" name="node" value="<?php echo $node->node_id ?>" />
		</form>		
		<?php
		include('./footer.php');
	break;
}


function show_modform($location) {
	global $node;
	echo '<ul style="list-style-type: none; margin: 0px; padding: 0px;">' . "\r\n";
	foreach ($node->revision->modules[$location] as $key => $module) {
		echo '<li><a href="?mode=args&amp;node=' . $node->node_id . '&amp;location=' . $location . '&amp;key=' . $key . '">';
		echo $module['extension'] . '::' . $module['module'] . '</a></li>' . "\r\n";
	}
	echo '</ul>' . "\r\n";
	
	echo '<input type="submit" name="submit-' . $location . '" value="' . __('Add') . '" />';
}
?>